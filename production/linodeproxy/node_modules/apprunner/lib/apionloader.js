// apionloader.js
// load apis with onLoad option
// Â© 2012 Harald Rudell <harald.rudell@therudells.com> (http://haraldrudell.com) MIT License

/*
load apis that have onLoad set in json configuration
*/
var getrequire = require('./getrequire')
var apilist = require('./apilist')

exports.doOnLoads = doOnLoads

// allow us to load apis...
require = getrequire.getRequire(require)

function doOnLoads(log) {
	var apiData = getrequire.getApiData()
	var logArgs = ['ApiMap:', apiData.apiMap, 'Paths:', apiData.apiPath]
	if (apiData.onloads.length) logArgs.push('Loading onload apis:', apiData.onloads.join(', '))
	else logArgs.push('onloads:', 0)
	log.apply(this, logArgs)

	apiData.onloads.forEach(doInitApi)

	function doInitApi(apiName) {
		/*
		apilist has apis mapped by api slogan
		getrequire has api configs by api module name
		the exports value can map between the two
		*/
		var apiExports = require(apiName)
		var initApiName = apilist.getInitApiName(apiExports)
		if (typeof initApiName !== 'string') throw new Error('name of init function unknown for api: ' + apiName)

		var fn = apiExports && apiExports[initApiName]
		if (typeof fn !== 'function') throw new Error('init function not function for api: ' + apiName)

		var firstChar = initApiName[0]
		var useNew = firstChar === firstChar.toLowerCase()

		if (useNew) new fn()
		else fn()
	}
}
