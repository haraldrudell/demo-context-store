// emailer.js
// Provide managed operations emails
// Â© 2012 Harald Rudell <harald.rudell@therudells.com> (http://haraldrudell.com) MIT License

var anomaly = require('./anomaly')

// http://nodejs.org/api/path.html
var path = require('path')

;[
send, setSendMail, hasSendMail
].forEach(function (f) {exports[f.name] = f})

var marker = path.basename(__filename, path.extname(__filename))

var sendMail

/*
Send email
opts: optional object
cb(err, success): optional function
*/
function send(opts, cb) {
	if (!opts) opts = {}

	if (sendMail) sendMail(opts, sendResult)
	else sendResult(new Error('Sendmail not available'))

	function sendResult(err, success) {
		if (err) {
			err[marker] = {
				opts: opts,
			}
			if (opts.anomaly !== false) anomaly.anomaly(err)
		}
		if (cb) cb(err, success)
	}
}

function setSendMail(f) {
	sendMail = f
}

function hasSendMail() {
	return !!sendMail
}
