// test-getrequire.js
// Â© 2012 Harald Rudell <harald.rudell@therudells.com> (http://haraldrudell.com) MIT License

var getrequire = require('../lib/getrequire')

var apilist = require('../lib/apilist')
var rqsm = require('../lib/rqs')
var apprunner = require('../lib/apprunner')
// http://nodejs.org/api/events.html
var events = require('events')
// https://github.com/haraldrudell/haraldutil
var haraldutil = require('haraldutil')
// http://nodejs.org/api/path.html
var path = require('path')

// https://github.com/haraldrudell/mochawrapper
var assert = require('mochawrapper')

var aa = apilist.addApi
var gr = rqsm.getRqs
var gt = haraldutil.getType

exports['GetRequire:'] = {
	'Exports': function () {
		assert.exportsTest(getrequire, 5)
	},
	'Init': function () {
		getrequire.init({appData: {}})
	},
	'MixIn-TODO': function () {
	},
	'GetRequire': function () {
		var actual = getrequire.getRequire(function () {})
		assert.equal(typeof actual, 'function')
	},

	'GetRequire NotFunction': function () {
		assert.throws(function () {
			getrequire.getRequire()
		}, /not function/)
	},
	'GetRequire Provided Emitter': function () {
		var emitter = new events.EventEmitter
		var api = 'API'
		var theExports = {}

		apilist.addApi = function () {return {}}
		var actual = getrequire.getRequire(function () {}, theExports, {api: api, initApi: function f() {}, emScope: emitter, ready: false})

		assert.equal(actual.emitter, emitter)
		assert.equal(emitter.id, api)
		assert.ok(theExports.f)
	},
	'GetRequire Requested Emitter': function () {
		var emScope = 'EMSCOPE'

		var actual = getrequire.getRequire(function () {}, null, {emScope: emScope})

		assert.ok(actual.emitter instanceof events.EventEmitter)
		assert.equal(actual.emitter.id, emScope)
	},
	'GetRequire InitApi Wrapper': function () {
		var api = 'API'
		var initApi = function () {}
		var theExports = {}

		getrequire.getRequire(function () {}, theExports, {api: api, initApi: function initApi() {}})

		assert.equal(typeof theExports.initApi, 'function')
		assert.notEqual(theExports.initApi, initApi)
	},
	'GetRequire InitApi Not Function': function () {
		var initApi = 5

		assert.throws(function () {
			getrequire.getRequire(function () {}, null, {initApi: initApi})
		}, /opts.initApi not function/)
	},
	'GetRequire InitApi Exports Null': function () {
		var initApi = function () {}

		assert.throws(function () {
			getrequire.getRequire(function () {}, null, {initApi: initApi})
		}, /exports null/)
	},
	'GetRequire AddApi': function () {
		var api = 'API'
		var opts = {api: api, initApi: function () {}}
		var theExports = {}
		var aAddApi = []
		var eAddApi = [['emitter', opts]]

		apilist.addApi = function (r, o) {aAddApi.push([r, o]); return {}}
		var actual = getrequire.getRequire(function () {}, theExports, opts)

		assert.ok((eAddApi[0][0] = aAddApi[0] && aAddApi[0][0]) instanceof events.EventEmitter)
		assert.deepEqual(aAddApi, eAddApi)
	},
	'GetRequire AddApi No InitApi': function () {
		var api = 'API'
		var opts = {api: api}

		assert.throws(function () {
			var actual = getrequire.getRequire(function () {}, null, opts)
		}, /InitApi missing/)
	},
	'GetRequire ApiList Error': function () {
		var api = 'API'
		var opts = {api: api, initApi: function () {}}
		var theExports = {}

		apilist.addApi = function () {return 'BAD'}
		assert.throws(function () {
			getrequire.getRequire(function () {}, theExports, opts)
		}, /BAD/)
	},
	'GetRequire Rqs': function () {
		var rqScope = 'RQSCOPE'
		var rqs = 5
		var aGetRqs = []
		var eGetRqs = [[0, rqScope, undefined]]

		rqsm.getRqs = function (cb, scope, to) {aGetRqs.push([cb, scope, to]); return rqs}
		var actual = getrequire.getRequire(function () {}, null, {rqScope: rqScope})

		assert.equal(actual.rqs, rqs)
		assert.equal(typeof (eGetRqs[0][0] = aGetRqs[0] && aGetRqs[0][0]), 'function')
		assert.deepEqual(aGetRqs, eGetRqs)
	},
	'GetRequire Rqs ApiName': function () {
		var api = 'API'
		var opts = {api: api, initApi: function () {}, timeoutMs: 5, rqScope: true}
		var aGetRqs = []
		var eGetRqs = [['cb', api, opts.timeoutMs]]
		var rqs = 5
		var theExports = {}
		var aAddApi = 0

		apilist.addApi = function () {aAddApi++; return {}}
		rqsm.getRqs = function (cb, scope, to) {aGetRqs.push([cb, scope, to]); return rqs}
		var actual = getrequire.getRequire(function () {}, theExports, opts)

		assert.ok(aAddApi)
		assert.equal(actual.rqs, rqs)
		assert.equal(typeof (eGetRqs[0][0] = aGetRqs[0] && aGetRqs[0][0]), 'function')
		assert.deepEqual(aGetRqs, eGetRqs)
	},
	'GetApiData': function () {
		var api = 'API'
		var apiOpts = {apiMap: {}}
		apiOpts.apiMap[api] = {onLoad: true}
		var expected = {
			apiMap: 1,
			onloads: [api],
			apiPath: 1,
		}

		getrequire.init({apiOpts: apiOpts, appData: {}})
		var actual = getrequire.getApiData()
		assert.deepEqual(actual, expected)
	},
	'after': function () {
		apilist.addApi = aa
		rqsm.getRqs = gr
	},
}
