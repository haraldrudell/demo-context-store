# !/bin/bash
# controlcommand slogan seconds command
#
# make sure only one instance that completes timely
#
# Written by Harald Rudell
# version: 120427 first version

set -eu

# verify arguments
[ "$#" -lt 3 ] && echo "controlcommand usage: slogan seconds command" && exit 1
[ "$1" = "" ] && echo "argument 1 should be slogan" && exit 1
[ "$2" = "" ] && echo "argument 2 should be seconds" && exit 1
[ "$3" = "" ] && echo "argument 3 should be command" && exit 1

# ensure only one instance
PIDFILE=/tmp/$1
if [ -r $PIDFILE ]; then
	OTHERPID=$(cat $PIDFILE)
	[ $(ps h $OTHERPID | wc -l) -gt 0 ] && echo "controlcommand: slogan $1 is already running: process id:$OTHERPID" && exit 1
fi
echo $$ >$PIDFILE

GETPID="$(dirname $0)/getpid"
# setup time monitoring process
#echo "monitoring:$$"
if [ $2 -gt 0 ]; then
( MONITORPID=$($GETPID); sleep $2; [ $(ps h $$ | wc -l) -gt 0 ] && echo "controlcommand: slogan $1 did not complete on time: process id:$$" && PIDS=$(ps h --ppid $$ -o pid | grep -v $MONITORPID) && echo "killing:$PIDS" && kill $PIDS && exit 1) &
fi

# execute command
#echo "Executing:$3"
$3

#done

