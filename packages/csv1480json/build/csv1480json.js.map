{"version":3,"sources":["webpack:///webpack/bootstrap 96cdc127b67e4f870aa3","webpack:///./src/run.js","webpack:///./src/CsvJsonConverter.js","webpack:///./src/Pipeline.js","webpack:///external \"stream\""],"names":["launch","fn","getOptions","errorHandler","catch","argv","process","console","log","useHeader","length","Error","readStream","stdin","writeStream","stdout","on","e","error","exit","FIELD_EOF","FIELD_NONE","FIELD_RECORD","separators","Array","from","CsvJsonConverter","constructor","o","addData","string","csv","isField","s","recordNo","Object","keys","getOutput","isEnd","headers","getHeader","output","record","getRecord","undefined","fields","getFieldList","count","fieldCount","map","v","index","JSON","stringify","join","list","field","getField","push","csvCh","chs","substring","m","quoteSearchIndex","indexOf","ch","reduce","r","Math","min","PipeLine","decodeStrings","encoding","_flush","callback","eh","setEncoding","pipe","_transform","chunk"],"mappings":"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","file":"csv1480json.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 96cdc127b67e4f870aa3","import CsvJsonConverter from './CsvJsonConverter'\n\nlaunch({fn: CsvJsonConverter, getOptions, errorHandler}).catch(errorHandler)\n\nfunction getOptions() {\n  const {argv} = process\n  console.log('getOptions argv', argv)\n  const useHeader = argv[2] === '--header'\n  if (argv.length !== (useHeader ? 3 : 2)) throw new Error('usage: csv1480json [--header]')\n  return {readStream: process.stdin, writeStream: process.stdout, useHeader}\n}\n\nasync function launch({fn, getOptions, errorHandler}) {\n  process.on('uncaughtException', errorHandler)\n    .on('unhandledRejection', errorHandler)\n  new fn({...getOptions(), errorHandler})\n}\n\nfunction errorHandler(e) {\n  console.error(e instanceof Error ? e/*TODO .message*/ : `errorHandler value: ${typeof e} ${e}`)\n  process.exit(1)\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/run.js","import Pipeline from './Pipeline'\n\n// getField result\nconst FIELD_EOF = 1 // end of file\nconst FIELD_NONE = 2 // data for complete field not seen yet\nconst FIELD_RECORD = 3 // got a complete record\n\nconst separators  = Array.from(',\\r\\n')\n\nexport default class CsvJsonConverter extends Pipeline {\n  constructor(o) {\n    super(o || false)\n    const {useHeader} = o || false\n    this.useHeader = !!useHeader\n    this.csv = ''\n    this.recordNo = 1\n    console.log(this.useHeader, Object.keys(o || false))\n  }\n\n  addData = string => this.csv += string\n\n  getOutput(isEnd) {\n    if (isEnd) this.isEnd = true\n    if (this.useHeader && !this.headers) if (!this.getHeader()) return\n    let output = ''\n    for (let record; record = this.getRecord(); output += record + '\\n') ;\n    return output || undefined\n  }\n\n  getRecord() {\n    const fields = this.getFieldList()\n    if (fields) { // got a record\n      const count = fields.length\n      const {fieldCount, recordNo, useHeader, headers} = this\n      if (!fieldCount) this.fieldCount = count\n      else if (count !== fieldCount) throw new Error(`Record ${recordNo} bad field count: ${count} expected ${fieldCount}`)\n      this.recordNo++\n      return `{${fields.map((v, index) => `${useHeader ? headers[index] : index + 1}: ${JSON.stringify(v)}`).join(', ')}}`\n    } else return false\n  }\n\n  getHeader() {\n    const list = this.getFieldList()\n    if (list) {\n      this.headers = list.map(v => JSON.stringify(v))\n      this.fieldCount = list.length\n    }\n  }\n\n  getFieldList() { // array of string or false\n    let fields = this.fields || (this.fields = [])\n    let field\n    while (this.isField(field = this.getField())) fields.push(field)\n    console.log('getFieldList end:', field, fields)\n    if (field === FIELD_RECORD) {\n      this.fields = null\n      return fields\n    } else return false // need to wait for more data or end of records\n  }\n\n  getField() { // string or FIELD_*\n    const {isEnd, recordNo} = this\n    const fields = this.fields.length\n    let {csv} = this\n    let csvCh = csv[0]\n\n    if (csvCh === '\\r' || csvCh === '\\n') { // skip the end of line terminating a previous record\n      if (csv.length < 2 && !isEnd) return FIELD_NONE // must have two characters to find \\r\\n\n      const chs = csv.substring(0, 2) === '\\r\\n' ? 2 : 1\n      this.csv = csv = csv.substring(chs)\n      return FIELD_RECORD // we have a complete record\n    }\n\n    if (!csv && isEnd) return fields ? FIELD_RECORD : FIELD_EOF\n\n    const m = `Record ${recordNo} field ${fields + 1}`\n\n    if (fields)\n      if (csvCh === ',') csvCh = (this.csv = csv = csv.substring(1))[0]\n      else throw new Error(`${m} missing field-separating comma`) // TODO insert location\n\n    if (csvCh === '\"') { // double-quoted field\n      let quoteSearchIndex =  this.quoteSearchIndex || 1 // where to start looking\n      let index\n      for (;;) {\n        let index = csv.indexOf('\"', quoteSearchIndex)\n        if (!~index) // no end-quote yet\n          if (!isEnd) {\n            this.quoteSearchIndex = quoteSearchIndex\n            return FIELD_NONE // no matching quote in data thus far\n          } else throw new Error(`${m} unmatched double quote`)\n        if (index - quoteSearchIndex < 2 || csv[index - 1] !== '\\\\') { // found unescaped ending double quote\n          this.quoteSearchIndex = 0\n          this.csv = csv.substring(index + 1)\n          return csv.substring(1, index)\n        }\n        quoteSearchIndex = index + 1 // skip escaped double quote\n      }\n    }\n\n    // it is an unquoted field\n    const index = separators.map(ch => csv.indexOf(ch)).reduce((r, index) => !~index ? r : !~r ? index : Math.min(r, index))\n    if (!~index) // none of the separators appeared\n      if (isEnd) {\n        this.csv = ''\n        return csv // field is rest of line\n      } else return FIELD_NONE // need more data\n    this.csv = csv.substring(index)\n    return csv.substring(0, index)\n  }\n\n  isField = s => typeof s === 'string'\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/CsvJsonConverter.js","/*\nÂ© 2017-present Harald Rudell <harald.rudell@gmail.com> (http://www.haraldrudell.com)\nThis source code is licensed under the ISC-style license found in the LICENSE file in the root directory of this source tree.\n*/\nimport {Transform} from 'stream'\n\nexport default class PipeLine extends Transform {\n  constructor({readStream, writeStream, errorHandler}) {\n    super({decodeStrings: false, encoding: 'utf8'})\n    const eh = typeof errorHandler\n    if (eh !== 'function') throw new Error(`PipeLine: errorHandler not function: ${eh}`)\n    readStream.on('error', errorHandler).setEncoding('utf8')\n      .pipe(this.on('error', errorHandler))\n      .pipe(writeStream.on('error', errorHandler))\n  }\n\n  _transform(chunk, encoding, callback) { // callback(err, chunk)\n    if (chunk.length) this.addData(chunk)\n    callback(null, this.getOutput())\n  }\n\n  _flush = callback => callback(null, this.getOutput(true))\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Pipeline.js","module.exports = require(\"stream\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"stream\"\n// module id = 3\n// module chunks = 0"],"sourceRoot":""}